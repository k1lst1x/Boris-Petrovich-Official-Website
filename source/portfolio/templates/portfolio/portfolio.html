{% extends "base.html" %}
{% load static %}

{% block title %}
  {% if case %}{{ case.title }} | Кейсы | TOO АЭС{% elif page %}{{ page.title }} | Портфолио | TOO АЭС{% else %}Портфолио | TOO АЭС{% endif %}
{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/portfolio.css' %}">
{% endblock %}

{% block content %}


{% if case %}
<section class="case">
  <div class="container">

    <nav class="breadcrumbs" aria-label="Навигация">
      <a class="breadcrumbs__link" href="/">Главная</a>
      <span class="breadcrumbs__sep">/</span>
      <a class="breadcrumbs__link" href="{% url 'portfolio:index' %}">Портфолио</a>
      <span class="breadcrumbs__sep">/</span>
      <span class="breadcrumbs__current">{{ case.title }}</span>
    </nav>

    <header class="case__head case__head--compact">
      <h1 class="case__title case__title--compact">{{ case.title }}</h1>
      {% if case.short_text %}
        <p class="case__subtitle muted">{{ case.short_text }}</p>
      {% endif %}
    </header>

    {% if case.cover_image %}
      <div class="case__cover case__cover--wide">
        <img src="{{ case.cover_image.url }}" alt="{{ case.title }}">
      </div>
    {% endif %}

    <div class="case__layout">

      <article class="case__content">
        {% if case.body %}
          <div class="case__body">
            {{ case.body|linebreaks }}
          </div>
        {% else %}
          <p class="muted">Описание кейса пока не заполнено.</p>
        {% endif %}

        {% if case_docs %}
          <div class="case-docs">
            <div class="case-docs__head">
              <h2 class="case-docs__title">Документы</h2>
              <p class="case-docs__subtitle muted">Бесплатные доступны сразу, платные после оплаты.</p>
            </div>

            <div class="case-docs__grid">
              {% for cd in case_docs %}
                {% with d=cd.document %}
                <article class="case-doc">
                  <div class="case-doc__media">
                    {% if d.preview_image %}
                      <img src="{{ d.preview_image.url }}" alt="{{ d.title }}">
                    {% else %}
                      <div class="case-doc__ph">DOC</div>
                    {% endif %}

                    <div class="case-doc__badges">
                      {% if d.access_type == "paid" %}
                        <span class="badge badge--paid">Платно</span>
                      {% else %}
                        <span class="badge badge--free">Бесплатно</span>
                      {% endif %}
                    </div>
                  </div>

                  <div class="case-doc__body">
                    <h3 class="case-doc__name">{{ d.title }}</h3>
                    <p class="case-doc__text muted">{{ d.description|default:"Описание"|truncatechars:90 }}</p>

                    {% if d.access_type == "paid" and d.price %}
                      <div class="case-doc__price">{{ d.price }} {{ d.currency }}</div>
                    {% endif %}

                    <div class="case-doc__actions">
                      <a class="btn btn--outline" href="{% url 'documents:detail' d.slug %}">Открыть</a>

                      {% if d.user_can_access %}
                      {% else %}
                        {% if d.access_type == "paid" %}
                          {% if d.user_needs_login %}
                            <a class="btn btn--orange" href="{% url 'login' %}">Войти</a>
                          {% else %}
                          {% endif %}
                        {% endif %}
                      {% endif %}
                    </div>
                  </div>
                </article>
                {% endwith %}
              {% endfor %}
            </div>
          </div>
        {% endif %}
      </article>

      <aside class="case__side">
        {% if images %}
          <div class="case-box">
            <h3 class="case-box__title">Галерея</h3>
            <div class="case-gallery">
              {% for img in images %}
                <figure class="case-gallery__item">
                  <img src="{{ img.image.url }}" alt="{{ img.caption|default:case.title }}">
                  {% if img.caption %}
                    <figcaption class="case-gallery__cap muted">{{ img.caption }}</figcaption>
                  {% endif %}
                </figure>
              {% endfor %}
            </div>
          </div>
        {% endif %}

      </aside>

    </div>
  </div>
</section>
{% endif %}



{% if page %}
<section class="pf pf--page">
  <div class="container">

    <nav class="breadcrumbs" aria-label="Навигация">
      <a class="breadcrumbs__link" href="/">Главная</a>
      <span class="breadcrumbs__sep">/</span>
      <a class="breadcrumbs__link" href="{% url 'portfolio:index' %}">Портфолио</a>
      <span class="breadcrumbs__sep">/</span>
      <span class="breadcrumbs__current">{{ page.title }}</span>
    </nav>

    <header class="pf__head pf__head--center pf__head--compact">
      <h1 class="pf__title pf__title--compact">{{ page.title }}</h1>

    </header>

    {% if cases %}
      <div class="pf-cases pf-cases--wide">
        {% for c in cases %}
          <article class="pf-case">
            <a class="pf-case__link" href="{% url 'portfolio:case_detail' c.slug %}">
              <div class="pf-case__img pf-case__img--wide">
                {% if c.cover_image %}
                  <img src="{{ c.cover_image.url }}" alt="{{ c.title }}">
                {% else %}
                  <div class="pf-case__ph" aria-hidden="true"></div>
                {% endif %}
              </div>
              <div class="pf-case__body">
                <h2 class="pf-case__title">{{ c.title }}</h2>
                <p class="pf-case__text muted">
                  {{ c.short_text|default:c.body|truncatechars:180 }}
                </p>
                <div class="btn btn--orange">Открыть кейс</div>
              </div>
            </a>
          </article>
        {% endfor %}
      </div>
    {% endif %}

    {% if documents %}
      <div class="pf-docs">
        <div class="pf-docs__head">
          <h2 class="pf-docs__title">Документы</h2>
          <p class="pf-docs__subtitle muted">Бесплатные доступны сразу, платные после оплаты.</p>
        </div>

        <div class="pf-docs__grid">
          {% for d in documents %}
            <article class="pf-doc">
              <div class="pf-doc__media">
                {% if d.preview_image %}
                  <img class="pf-doc__img" src="{{ d.preview_image.url }}" alt="{{ d.title }}">
                {% else %}
                  <div class="pf-doc__ph">DOC</div>
                {% endif %}
                <div class="pf-doc__badges">
                  {% if d.access_type == 'paid' %}
                    <span class="badge badge--paid">Платно</span>
                  {% else %}
                    <span class="badge badge--free">Бесплатно</span>
                  {% endif %}
                </div>
              </div>

              <div class="pf-doc__body">
                <h3 class="pf-doc__title2">{{ d.title }}</h3>
                <p class="pf-doc__text muted">{{ d.description|default:"Описание"|truncatechars:110 }}</p>

                <div class="pf-doc__meta">
                  {% if d.access_type == 'paid' and d.price %}
                    <span class="pf-doc__price">{{ d.price }} {{ d.currency }}</span>
                  {% endif %}
                </div>

                <div class="pf-doc__actions">
                  <a class="btn btn--outline" href="{% url 'documents:detail' d.slug %}">Открыть</a>

                  {% if d.user_can_access %}
                  {% else %}
                    {% if d.access_type == 'paid' %}
                      {% if d.user_needs_login %}
                        <a class="btn btn--orange" href="{% url 'login' %}">Войти</a>
                      {% else %}
                        <a class="btn btn--orange" href="{% url 'documents:pay' d.slug %}">Оплатить</a>
                      {% endif %}
                    {% endif %}
                  {% endif %}
                </div>
              </div>
            </article>
          {% endfor %}
        </div>
      </div>
    {% endif %}

    <div class="pf-actions pf-actions--center pf-actions--spaced">
      <a class="btn btn--outline" href="{% url 'portfolio:index' %}">← Все разделы</a>
      <button class="btn btn--orange" data-modal-open="contact">Запросить консультацию</button>
    </div>

  </div>
</section>
{% endif %}

{% endblock %}
