{% extends "base.html" %}
{% load static %}

{% block title %}Рекомендации | TOO АЭС{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/home.css' %}">
{% endblock %}

{% block content %}
<section class="recs-page">
  <div class="container">
    <div class="section__head">
      <h1 class="section__title">Рекомендации</h1>
      <p class="section__subtitle">Все сертификаты и документы, подтверждающие наш опыт</p>
    </div>

    <div class="recommend-grid">
      {% if recommendations %}
        {% for r in recommendations %}
          <a class="rec-doc" href="{{ r.document.url }}" target="_blank" rel="noopener">
            <div class="rec-preview" data-pdf="{{ r.document.url }}">
              <canvas aria-hidden="true"></canvas>
            </div>
            <div class="rec-caption">{{ r.title }}</div>
          </a>
        {% endfor %}
      {% else %}
        <p class="muted">Рекомендаций пока нет.</p>
      {% endif %}
    </div>

    <div style="margin-top:22px; text-align:center;">
      <a class="btn btn--orange" href="{% url 'core:home' %}">На главную</a>
    </div>
  </div>
</section>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener("DOMContentLoaded", () => {
  if (!window["pdfjsLib"]) return;

  pdfjsLib.GlobalWorkerOptions.workerSrc =
    "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js";

  const previews = document.querySelectorAll(".rec-preview");

  previews.forEach(async (box) => {
    const url = box.dataset.pdf;
    const canvas = box.querySelector("canvas");
    if (!url || !canvas) return;

    try {
      const pdf = await pdfjsLib.getDocument(url).promise;
      const page = await pdf.getPage(1);

      const viewport = page.getViewport({ scale: 1 });

      const containerWidth = box.clientWidth - 28;
      const scale = containerWidth / viewport.width;

      const scaledViewport = page.getViewport({ scale });

      canvas.width = scaledViewport.width;
      canvas.height = scaledViewport.height;

      const ctx = canvas.getContext("2d");

      await page.render({
        canvasContext: ctx,
        viewport: scaledViewport
      }).promise;

    } catch (err) {
      console.warn("PDF preview error:", url, err);
    }
  });
});
</script>
{% endblock %}
